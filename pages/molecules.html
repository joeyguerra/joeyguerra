<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project Status - Molecule Model</title>
  <script src="/socket.io/socket.io.js"></script>
  <script type="module" id="HotReloader">
    import { HotReloader } from '/__juphjacs__/HotReloader.mjs'
    const hotReloader = new HotReloader(window, io('/hot-reload'))
  </script>
  <style>
    body {
      font-family: sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 2rem;
    }
    h1 {
      margin-bottom: 0.5rem;
    }
    .summary {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }
    .molecule-visual {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 1rem;
      align-items: center;;
    }
    .molecule {
      width: 20px;
      height: 20px;
      border-radius: 50%;
    }
    .planning { background: #4169E1; }
    .implementation { background: #DAA520; }
    .release { background: #DC143C; }
    .controls {
      margin-top: 2rem;
    }
    .controls label {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
    }
    .control-label {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      min-width: 160px;
    }
    .control-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      flex: 0 0 12px;
    }
    #upload {
      margin-top: 2rem;
    }
  </style>
</head>
<body>
  <h1>What's the Status of your Jira Project?</h1>
  <p>Different aspects of the software development dynamically interplay with each other over time, all in service of accomplishing a customer's job-to-be-done</p>
  <div class="summary">
    <p><strong>Overview:</strong> The following represents the current distribution of energy and focus across different modes of work in the project: planning, implementation, and release. Each dot is like a molecule representing one unit of effort or attention.</p>
    <p>You can upload a Jira JSON or XML export to see the distribution of work over time.</p>
    <p>Or you can see an example of the interplay by moving the sliders below.</p>
    <div class="controls">
      <label>
        <span class="control-label">
          <span class="control-dot planning"></span>
          Planning
        </span>
        <input type="range" id="planningRange" min="0" max="100" value="25">
      </label>
      <label>
        <span class="control-label">
          <span class="control-dot implementation"></span>
          Implementation
        </span>
        <input type="range" id="implementationRange" min="0" max="100" value="50">
      </label>
      <label>
        <span class="control-label">
          <span class="control-dot release"></span>
          Code/Release
        </span>
        <input type="range" id="releaseRange" min="0" max="100" value="25" readonly>
      </label>
    </div>

    <div class="classification terms">
      <h3>Classification Terms:</h3>
      <ul>
        <li><strong>Planning & Designing:</strong> design|plan|requirement</li>
        <li><strong>Implementation:</strong> implement|develop|feature|build</li>
        <li><strong>Code/Release:</strong> test|release|deploy|merge|qa|bug</li>
      </ul>
    </div>

    <div id="upload">
      <label for="jiraFile">Upload Jira JSON or XML Export:</label>
      <input type="file" id="jiraFile" accept=".json,.xml" />
    </div>

    <div class="molecule-visual" id="moleculeGrid"></div>

  </div>

  <script>
    const TOTAL = 200;
    const grid = document.getElementById("moleculeGrid");
    const planningRange = document.getElementById("planningRange");
    const implementationRange = document.getElementById("implementationRange");
    const releaseRange = document.getElementById("releaseRange");
    const jiraFile = document.getElementById("jiraFile");

    let sortedIssues = []; // new global variable to store sorted issues

    function updateReleaseValue() {
      const p = parseInt(planningRange.value);
      const i = parseInt(implementationRange.value);
      let r = 100 - p - i;
      r = Math.max(0, Math.min(r, 100));
      releaseRange.value = r;
    }

    function updateMolecules() {
      // if a JIRA JSON export has been loaded, order dots by timestamp
      if (sortedIssues.length > 0) {
        grid.innerHTML = "";
        // Compute durations in minutes for each issue
        const durations = sortedIssues.map(issue => {
          const startTime = new Date(issue.start);
          const endTime = new Date(issue.completed);
          return (endTime - startTime) / 60000;
        });
        const minDiff = Math.min(...durations);
        const maxDiff = Math.max(...durations);
        const baseSize = 10;
        const maxSize = 100;
        sortedIssues.forEach((issue, index) => {
          const text = `${issue.fields.summary || ''} ${issue.fields.description || ''}`;
          const category = inferCategory(text) || "planning";
          const el = document.createElement("div");
          el.className = `molecule ${category}`;
          const diffMinutes = durations[index];
          let size;
          if (maxDiff === minDiff) {
            size = baseSize;
          } else {
            size = baseSize + ((diffMinutes - minDiff) / (maxDiff - minDiff)) * (maxSize - baseSize);
          }
          el.style.width = `${size}px`;
          el.style.height = `${size}px`;
          grid.appendChild(el);
        });
        return;
      }
      // ...existing code for slider-based random distribution...
      updateReleaseValue();
      const planning = parseInt(planningRange.value);
      const implementation = parseInt(implementationRange.value);
      const release = parseInt(releaseRange.value);
      const total = planning + implementation + release;
      const distribution = [
        ...Array(Math.round(TOTAL * (planning / total))).fill("planning"),
        ...Array(Math.round(TOTAL * (implementation / total))).fill("implementation"),
        ...Array(Math.round(TOTAL * (release / total))).fill("release")
      ];
      for (let i = distribution.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [distribution[i], distribution[j]] = [distribution[j], distribution[i]];
      }
      grid.innerHTML = "";
      distribution.forEach(type => {
        const el = document.createElement("div");
        el.className = `molecule ${type}`;
        grid.appendChild(el);
      });
    }

    function inferCategory(text) {
      if (/design|plan|requirement/i.test(text)) return 'planning';
      if (/implement|develop|feature|build/i.test(text)) return 'implementation';
      if (/test|release|deploy|merge|qa|bug/i.test(text)) return 'release';
      return null;
    }

    function parseXmlIssues(xmlText) {
      const parser = new DOMParser()
      const xmlDoc = parser.parseFromString(xmlText, 'application/xml')
      const parseError = xmlDoc.querySelector('parsererror')
      if (parseError) {
        throw new Error('Invalid XML')
      }

      const items = Array.from(xmlDoc.querySelectorAll('item'))
      return items.map((item) => {
        const summary = item.querySelector('summary')?.textContent || ''
        const description = item.querySelector('description')?.textContent || ''
        const created = item.querySelector('created')?.textContent || ''
        const updated = item.querySelector('updated')?.textContent || ''
        const status = item.querySelector('status')?.textContent || ''
        return {
          timestamp: created || updated || '',
          start: created || '',
          completed: updated || created || '',
          fields: {
            summary,
            description,
            status
          }
        }
      })
    }

    jiraFile.addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          let issues = []
          if (file.name.toLowerCase().endsWith('.xml')) {
            issues = parseXmlIssues(e.target.result)
          } else {
            const data = JSON.parse(e.target.result, function (key, value) {
              if (['timestamp', 'start', 'completed'].includes(key)) {
                return new Date(value);
              }
              return value;
            });
            issues = data.issues || []
          }
          let planning = 0, implementation = 0, release = 0;

          issues.forEach(issue => {
            const text = `${issue.fields.summary || ''} ${issue.fields.description || ''}`;
            const category = inferCategory(text);
            if (category === 'planning') planning++;
            else if (category === 'implementation') implementation++;
            else if (category === 'release') release++;
          });

          const total = planning + implementation + release;
          if (total > 0) {
            planningRange.value = Math.round((planning / total) * 100);
            implementationRange.value = Math.round((implementation / total) * 100);
            releaseRange.value = Math.round((release / total) * 100);
          }

          // Sort issues by timestamp (assumes timestamp is a valid ISO string)
          sortedIssues = issues.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
          updateMolecules();
        } catch (err) {
          alert("Invalid file. Please upload a valid Jira JSON or XML (RSS) export.");
        }
        jiraFile.value = ""; // clear file field after handling
      };
      reader.readAsText(file);
    });

    planningRange.addEventListener("input", updateMolecules);
    implementationRange.addEventListener("input", updateMolecules);

    updateMolecules();
  </script>
</body>
</html>

<section style="padding: 20px">
  <header style="margin-bottom: 16px">
    <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px">
      <h1 style="margin:0">NATO Fracture Dashboard</h1>
      <button id="refreshBtn" style="padding:8px 12px; background:#0066cc; color:white; border:none; border-radius:4px; cursor:pointer; font-size:14px">Refresh Data</button>
    </div>
    <div id="refreshStatus" style="display:none; padding:8px 12px; background:#f0f0f0; border-radius:4px; margin-bottom:8px"></div>
  </header>

  ${current ? `
  <div style='display:flex; gap:16px; flex-wrap:wrap; margin-bottom:20px'>
    <div style='flex:1; min-width:280px; border:1px solid #ddd; border-radius:8px; padding:12px'>
      <h2 style='font-size:18px; margin-bottom:8px'>Current Score</h2>
      <div style='font-size:32px; font-weight:700'>${currentScore}</div>
      <div style='font-size:14px; color:#555'>${currentBand}</div>
      <div style='font-size:12px; color:#777; margin-top:6px'>Week ending ${current.week_ending}</div>
    </div>
    <div style='flex:2; min-width:360px; border:1px solid #ddd; border-radius:8px; padding:12px'>
      <h2 style='font-size:18px; margin-bottom:8px'>What changed this week</h2>
      <div style='white-space:pre-wrap; font-size:14px'>${(current.notes || '').replace(/[<>]/g,'')}</div>
    </div>
  </div>

  <div style='overflow:auto; margin-bottom:20px'>
    <h3 style='font-size:16px; margin: 10px 0'>Pillars (latest)</h3>
    <table style='width:100%; border-collapse:collapse'>
      <thead>
        <tr>
          <th style='text-align:left; border-bottom:1px solid #ccc; padding:8px'>Pillar</th>
          <th style='text-align:right; border-bottom:1px solid #ccc; padding:8px'>Heat</th>
          <th style='text-align:right; border-bottom:1px solid #ccc; padding:8px'>Weight</th>
          <th style='text-align:right; border-bottom:1px solid #ccc; padding:8px'>Contribution</th>
          <th style='text-align:right; border-bottom:1px solid #ccc; padding:8px'>Evidence</th>
        </tr>
      </thead>
      <tbody>
        ${current.pillars.map(p => `
          <tr>
            <td style='padding:8px'>${p.pillar_key.replace('_',' ')}</td>
            <td style='padding:8px; text-align:right'>${p.heat}</td>
            <td style='padding:8px; text-align:right'>${p.weight}</td>
            <td style='padding:8px; text-align:right'>${p.contribution}</td>
            <td style='padding:8px; text-align:right'>${p.evidenceCount}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  </div>
  ` : `
  <div style='border:1px dashed #bbb; border-radius:8px; padding:16px; margin-bottom:20px'>
    <p>No snapshots yet</p>
  </div>
  `}

  <div style='overflow:auto; margin-bottom:20px'>
    <h3 style='font-size:16px; margin: 10px 0'>12-Week History</h3>
    <table style='width:100%; border-collapse:collapse'>
      <thead>
        <tr>
          <th style='text-align:left; border-bottom:1px solid #ccc; padding:8px'>Week ending</th>
          <th style='text-align:right; border-bottom:1px solid #ccc; padding:8px'>Score</th>
          <th style='text-align:left; border-bottom:1px solid #ccc; padding:8px'>Band</th>
          <th style='text-align:left; border-bottom:1px solid #ccc; padding:8px'>Notes</th>
          <th style='text-align:left; border-bottom:1px solid #ccc; padding:8px'>Details</th>
        </tr>
      </thead>
      <tbody>
        ${history.map(h => `
          <tr>
            <td style='padding:8px'>${h.week_ending}</td>
            <td style='padding:8px; text-align:right'>${h.score}</td>
            <td style='padding:8px'>${h.band}</td>
            <td style='padding:8px'>${h.notesSnippet}</td>
            <td style='padding:8px'><a href='/dashboards/nato-fracture.html?week=${h.week_ending}'>View</a></td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  </div>

  ${details ? `
  <div style='border:1px solid #ddd; border-radius:8px; padding:12px; margin-bottom:20px'>
    <h3 style='font-size:16px; margin-bottom:8px'>Details for ${details.week_ending}</h3>
    <div style='white-space:pre-wrap; font-size:14px; margin-bottom:8px'>${(details.notes || '').replace(/[<>]/g,'')}</div>
    ${details.pillars.map(p => `
      <div style='margin-bottom:8px'>
        <strong>${p.pillar_key.replace('_',' ')}</strong>
        <span style='margin-left:8px'>heat ${p.heat} • weight ${p.weight} • contribution ${p.contribution}</span>
        ${p.evidenceList.length > 0 ? `
          <ul style='margin:6px 0 0 18px'>
            ${p.evidenceList.map(e => `<li><a href='${e.url}' rel='noopener noreferrer'>${e.label || e.url}</a>${e.note ? ` — ${e.note}` : ''}</li>`).join('')}
          </ul>
        ` : ''}
      </div>
    `).join('')}
  </div>
  ` : ''}

  <div style='border:1px solid #ddd; border-radius:8px; padding:12px'>
    <h3 style='font-size:16px; margin-bottom:8px'>Add Weekly Entry</h3>
    <form method='post' action='/dashboards/nato-fracture.html' style='display:grid; gap:8px'>
      <label>Week ending
        <input type='date' name='week_ending' required />
      </label>

      <label>Notes
        <textarea name='notes' rows='4' placeholder='What changed this week'></textarea>
      </label>

      <fieldset style='border:1px solid #eee; padding:8px'>
        <legend>Pillar heats (0–5) and optional evidence</legend>
        ${[
          ['elite_language','Elite language'],
          ['defense_posture','Defense posture'],
          ['markets','Markets'],
          ['public_opinion','Public opinion'],
          ['media_attention','Media attention']
        ].map(([key,label]) => `
          <div style='display:flex; gap:8px; align-items:flex-start; margin-bottom:6px'>
            <label style='min-width:160px'>${label}
              <input type='number' min='0' max='5' name='heat_${key}' required />
            </label>
            <label style='flex:1'>Evidence (JSON array or newline list)
              <textarea name='evidence_${key}' rows='3' placeholder='[{"label":"...","url":"...","note":"..."}] or one URL per line'></textarea>
            </label>
          </div>
        `).join('')}
      </fieldset>

      <div>
        <button type='submit'>Save</button>
      </div>
    </form>
  </div>
</section>
<script>
  document.getElementById('refreshBtn')?.addEventListener('click', async () => {
    const btn = document.getElementById('refreshBtn')
    const status = document.getElementById('refreshStatus')
    const originalText = btn.textContent
    
    btn.disabled = true
    btn.textContent = 'Refreshing...'
    status.style.display = 'block'
    status.textContent = 'Collecting data...'
    status.style.background = '#f0f0f0'
    
    try {
      const resp = await fetch('/dashboards/nato-fracture.html?action=refresh', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
      const data = await resp.json()
      
      if (data.success) {
        status.textContent = 'Data refreshed! Reloading...'
        status.style.background = '#e8f5e9'
        setTimeout(() => location.reload(), 1000)
      } else {
        status.textContent = 'Error: ' + (data.error || 'Unknown error')
        status.style.background = '#ffebee'
        btn.disabled = false
        btn.textContent = originalText
      }
    } catch (e) {
      status.textContent = 'Error: ' + e.message
      status.style.background = '#ffebee'
      btn.disabled = false
      btn.textContent = originalText
    }
  })
</script>